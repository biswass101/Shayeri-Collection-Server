// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  user
  admin
}

model User {
  id             Int                 @id @default(autoincrement())
  email          String              @unique
  name           String?
  avatarUrl      String?
  passwordHash   String              @default("")
  role           UserRole            @default(user)
  likes          VideoLike[]
  comments       Comment[]
  shares         VideoShareEvent[]
  downloads      VideoDownloadEvent[]
  notifications  Notification[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now()) @updatedAt
}

model Category {
  id             Int       @id @default(autoincrement())
  name           String    @unique
  slug           String    @unique
  description    String?
  videos         Video[]
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Video {
  id                  Int                 @id @default(autoincrement())
  title               String
  description         String?
  categoryId          Int
  category            Category            @relation(fields: [categoryId], references: [id])
  cloudinaryPublicId  String              @unique
  videoUrl            String
  thumbnailUrl        String?
  durationSeconds     Int?
  isPublished         Boolean             @default(true)
  viewsCount          Int                 @default(0)
  textSections        VideoTextSection[]
  likes               VideoLike[]
  comments            Comment[]
  shares              VideoShareEvent[]
  downloads           VideoDownloadEvent[]
  createdByAdminId    Int
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([categoryId, createdAt])
}

model VideoTextSection {
  id             Int      @id @default(autoincrement())
  videoId        Int
  video          Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  position       Int
  heading        String?
  body           String
  createdAt      DateTime @default(now())

  @@unique([videoId, position])
}

model VideoLike {
  id             Int      @id @default(autoincrement())
  videoId        Int
  userId         Int
  video          Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())

  @@unique([videoId, userId])
}

model Comment {
  id             Int      @id @default(autoincrement())
  videoId        Int
  userId         Int
  body           String
  isDeleted      Boolean  @default(false)
  video          Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentId       Int?
  parent         Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies        Comment[] @relation("CommentReplies")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([videoId, createdAt])
  @@index([parentId, createdAt])
}

model VideoShareEvent {
  id             Int      @id @default(autoincrement())
  videoId        Int
  userId         Int
  channel        String?
  video          Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
}

model VideoDownloadEvent {
  id             Int      @id @default(autoincrement())
  videoId        Int
  userId         Int
  video          Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
}

model Notification {
  id             Int      @id @default(autoincrement())
  userId         Int
  videoId        Int?
  type           String
  title          String
  body           String?
  isRead         Boolean  @default(false)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())

  @@index([userId, createdAt])
}
